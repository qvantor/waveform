import { rxModel, rxModelReact } from '@waveform/rxjs-react';
import { InputControllerModule } from './input-controller';
import { AdsrEnvelopeModule, AdsrEnvelopeModel } from './adsr-envelope';
import { OscillatorModule } from './oscillator';
import { Note } from '@waveform/ui-kit';
import { noteFrequency } from '../../../common/constants';

interface Deps {
  inputController: InputControllerModule;
  adsrEnvelope: AdsrEnvelopeModule;
  oscillator: OscillatorModule;
}

const getFq = ([octave, note]: Note) => noteFrequency[note] * 2 ** (octave - 1);
const noteToString = ([octave, note]: Note) => `${note}${octave}`;

const wave: [number[], number[]] = [
  [
    0.10448351502418518, 0.10502222180366516, 0.1061595231294632, 0.0934235006570816, 0.08206575363874435,
    0.060909051448106766, 0.04922502860426903, 0.03215823322534561, 0.024409767240285873, 0.01511915773153305,
    0.016852345317602158, 0.01212521642446518, 0.00699707493185997, -0.004897113889455795,
    -0.01713119074702263, -0.02386908046901226, -0.017537517473101616, 0.011815108358860016,
    0.05281698703765869, 0.10010150074958801, 0.09683629125356674, 0.03346027433872223, -0.2009480893611908,
    -0.4156370759010315, -0.5959677696228027, -0.6017518639564514, -0.4693124294281006, -0.1792641431093216,
    0.1289336383342743, 0.2268206775188446, 0.23136089742183685, 0.14037682116031647, 0.10803739726543427,
    0.14046995341777802, 0.3019498586654663, 0.5174527764320374, 0.6729899048805237, 0.7800775766372681,
    0.870128870010376, 0.8847571611404419, 0.8415672779083252, 0.5719866752624512, 0.16139528155326843,
    -0.18523073196411133, -0.48062267899513245, -0.6887436509132385, -0.8373644351959229, -0.9183270931243896,
    -0.8587234616279602, -0.6784107685089111, -0.3575252592563629, -0.0024965107440948486, 0.2786247432231903,
    0.4686860144138336, 0.5181005001068115, 0.5291099548339844, 0.48951178789138794, 0.4549306631088257,
    0.4033580422401428, 0.3529973030090332, 0.27803489565849304, 0.18431101739406586, 0.09139686077833176,
    0.01920369267463684, -0.016053631901741028, -0.0063022226095199585, 0.043163105845451355,
    0.11852043867111206, 0.20941095054149628, 0.26843583583831787, 0.2872571647167206, 0.2516075670719147,
    0.18435007333755493, 0.0495276153087616, -0.08312486112117767, -0.1802607774734497, -0.2269684374332428,
    -0.22219610214233398, -0.18409359455108643, -0.12813352048397064, -0.08244463056325912,
    -0.058548543602228165, -0.06658615916967392, -0.10010451823472977, -0.14974913001060486,
    -0.1866968721151352, -0.2099137306213379, -0.21339014172554016, -0.20071151852607727,
    -0.18130779266357422, -0.16167548298835754, -0.1486392766237259, -0.14061859250068665,
    -0.1447944939136505, -0.155537411570549, -0.18058837950229645, -0.21666963398456573, -0.2608121335506439,
    -0.3119860291481018, -0.3437052071094513, -0.3507753014564514, -0.3273286819458008, -0.27418798208236694,
    -0.19672046601772308, -0.11594036966562271, -0.060686200857162476, -0.037356164306402206,
    -0.06284879893064499, -0.17703743278980255, -0.3610922396183014, -0.5537627339363098, -0.7111671566963196,
    -0.7746522426605225, -0.7714220881462097, -0.7238486409187317, -0.6348170042037964, -0.5358085632324219,
    -0.43273118138313293, -0.36326053738594055, -0.3194829821586609, -0.32248324155807495,
    -0.37020623683929443, -0.44735127687454224, -0.5551099181175232, -0.6366302967071533, -0.6988182067871094,
    -0.7172124981880188, -0.707405149936676, -0.6848628520965576, -0.6389889717102051, -0.5999218225479126,
    -0.5509392619132996, -0.5122328996658325, -0.4749603569507599, -0.4467235207557678, -0.43611663579940796,
    -0.44996798038482666, -0.5030556917190552, -0.5643859505653381, -0.6299237608909607, -0.6585403680801392,
    -0.6582909822463989, -0.6368449330329895, -0.597009003162384, -0.5558702945709229, -0.5063902735710144,
    -0.48005425930023193, -0.460945725440979, -0.4705052673816681, -0.5073353052139282, -0.547902524471283,
    -0.5938013792037964, -0.6188962459564209, -0.6336452960968018, -0.6271253824234009, -0.6081606149673462,
    -0.5802285671234131, -0.5425553917884827, -0.5107725262641907, -0.478653222322464, -0.4537544548511505,
    -0.43061742186546326, -0.414628803730011, -0.4063717722892761, -0.40379318594932556, -0.40911218523979187,
    -0.41670867800712585, -0.4263136684894562, -0.43700098991394043, -0.44875770807266235, -0.455673485994339,
    -0.4587395191192627, -0.4546493887901306, -0.4463086724281311, -0.43509891629219055, -0.41931086778640747,
    -0.40406906604766846, -0.39097315073013306, -0.38305678963661194, -0.378329336643219, -0.3753911256790161,
    -0.36946070194244385, -0.36156386137008667, -0.3486555516719818, -0.33325064182281494,
    -0.31966346502304077, -0.3054848611354828, -0.29387521743774414, -0.28254199028015137, -0.271638959646225,
    -0.25234755873680115, -0.2327854335308075, -0.21673768758773804, -0.2057359218597412, -0.2094694972038269,
    -0.21877096593379974, -0.23523421585559845, -0.24799227714538574, -0.2536837160587311,
    -0.24949589371681213, -0.23221272230148315, -0.20970363914966583, -0.18036098778247833,
    -0.15533268451690674, -0.13344347476959229, -0.11698882281780243, -0.1063358336687088,
    -0.09534085541963577, -0.08495428413152695, -0.0715448260307312, -0.05882751941680908,
    -0.04487961530685425, -0.032787661999464035, -0.02392539381980896, -0.01647646352648735,
    -0.010161057114601135, -0.0006084740161895752, 0.011700455099344254, 0.028602682054042816,
    0.048965103924274445, 0.0718817263841629, 0.09485169500112534, 0.11703306436538696, 0.14032302796840668,
    0.16392569243907928, 0.18976449966430664, 0.21441645920276642, 0.23474936187267303, 0.2489628791809082,
    0.25270649790763855, 0.2463817000389099, 0.2313065230846405, 0.2077166587114334, 0.18110410869121552,
    0.15759232640266418, 0.14037764072418213, 0.13452954590320587, 0.1429288387298584, 0.1658637672662735,
    0.20473520457744598, 0.2614411413669586, 0.3399825096130371, 0.4413147270679474, 0.5591330528259277,
    0.6822073459625244, 0.7898043394088745, 0.8600878715515137, 0.8874843120574951, 0.876983106136322,
    0.8343315124511719, 0.7672169804573059, 0.6855430006980896, 0.6012128591537476, 0.5244220495223999,
    0.4613974988460541, 0.41609394550323486, 0.387090265750885, 0.37023383378982544, 0.36412501335144043,
    0.36742493510246277, 0.3793042004108429, 0.40004676580429077, 0.4306037724018097, 0.4762430191040039,
    0.54129558801651, 0.623568594455719, 0.7173302173614502, 0.8122366070747375, 0.8960644602775574,
    0.9608007669448853, 1.0013494491577148, 1.016584038734436, 1.009718894958496, 0.9848771095275879,
    0.9478676319122314, 0.9040949940681458, 0.8565701246261597, 0.8093805909156799, 0.7665699124336243,
    0.7302533984184265, 0.7019730806350708, 0.6817910671234131, 0.6683523058891296, 0.6598062515258789,
    0.6539314985275269, 0.6499284505844116, 0.6483883261680603, 0.6487450003623962, 0.6494936943054199,
    0.6508461833000183, 0.6538336277008057, 0.6577848792076111, 0.6623547077178955, 0.6679501533508301,
    0.6736255288124084, 0.6793582439422607, 0.6859105825424194, 0.6926671862602234, 0.6992945671081543,
    0.7049228549003601, 0.7089816927909851, 0.7135046124458313, 0.7184776663780212, 0.7220849990844727,
    0.7249262928962708, 0.7264643907546997, 0.7257802486419678, 0.7250941395759583, 0.725018322467804,
    0.7238175272941589, 0.7216284275054932, 0.7190057039260864, 0.7153927683830261, 0.71075838804245,
    0.7058013677597046, 0.7010460495948792, 0.6962971687316895, 0.6910929679870605, 0.6858209371566772,
    0.6811052560806274, 0.6765482425689697, 0.6720123291015625, 0.6682147979736328, 0.6645369529724121,
    0.6598435640335083, 0.6548328399658203, 0.6500875949859619, 0.6450116038322449, 0.6396973729133606,
    0.6341830492019653, 0.6274957656860352, 0.6196471452713013, 0.6121208667755127, 0.6052449941635132,
    0.5976292490959167, 0.5892090797424316, 0.5814797878265381, 0.5742658376693726, 0.5660264492034912,
    0.5562018752098083, 0.5445573329925537, 0.53070068359375, 0.515234649181366, 0.49903604388237,
    0.48234355449676514, 0.4658730924129486, 0.45030319690704346, 0.43522483110427856, 0.4210393726825714,
    0.40893152356147766, 0.39883843064308167, 0.39078477025032043, 0.3851615786552429, 0.3804575204849243,
    0.3746429979801178, 0.3679233491420746, 0.3616572618484497, 0.35576939582824707, 0.34934675693511963,
    0.3427169919013977, 0.33600425720214844, 0.3283393383026123, 0.3204537034034729, 0.31365180015563965,
    0.3073289394378662, 0.30063071846961975, 0.2938205599784851, 0.2870544493198395, 0.2802146375179291,
    0.27325016260147095, 0.26600784063339233, 0.2574509382247925, 0.2470548450946808, 0.23550818860530853,
    0.22249817848205566, 0.20825791358947754, 0.19436269998550415, 0.18059927225112915, 0.16754499077796936,
    0.1567765772342682, 0.1463155448436737, 0.13574223220348358, 0.12756100296974182, 0.12013378739356995,
    0.11212509870529175, 0.10501183569431305, 0.09702634811401367, 0.08769290149211884, 0.07896481454372406,
    0.06907215714454651, 0.058000266551971436, 0.04830581322312355, 0.038511328399181366, 0.02815920114517212,
    0.01934298872947693, 0.011027291417121887, 0.001970648765563965, -0.007055982947349548,
    -0.015622228384017944, -0.023672714829444885, -0.03158845007419586, -0.039587438106536865,
    -0.04788951575756073, -0.05719377100467682, -0.06670986115932465, -0.07555648684501648,
    -0.08410468697547913, -0.0918678343296051, -0.09876477718353271, -0.10615290701389313,
    -0.11526203155517578, -0.1261691153049469, -0.137540802359581, -0.14936214685440063, -0.16231727600097656,
    -0.17459917068481445, -0.18583552539348602, -0.19759221374988556, -0.20894670486450195,
    -0.21891283988952637, -0.2281329333782196, -0.23698456585407257, -0.245139479637146, -0.2516263723373413,
    -0.2570604383945465, -0.2628215551376343, -0.2682412564754486, -0.2736838757991791, -0.28100600838661194,
    -0.2906230092048645, -0.30237048864364624, -0.31579819321632385, -0.3301132917404175,
    -0.34433695673942566, -0.3572666049003601, -0.3693690299987793, -0.3810277581214905, -0.39077675342559814,
    -0.3988350033760071, -0.40656575560569763, -0.41366592049598694, -0.4200970530509949, -0.4268772602081299,
    -0.4341309070587158, -0.4416724145412445, -0.4504905939102173, -0.4604978859424591, -0.47021543979644775,
    -0.4797009825706482, -0.4888743460178375, -0.49811142683029175, -0.5097814202308655, -0.5227820873260498,
    -0.5355328321456909, -0.5500341057777405, -0.5640727877616882, -0.5741788148880005, -0.5815905928611755,
    -0.5863778591156006, -0.5886927843093872, -0.5905930995941162, -0.5926005840301514, -0.5966461896896362,
    -0.6051017045974731, -0.6175166964530945, -0.6320315599441528, -0.6455445885658264, -0.6566449403762817,
    -0.6655686497688293, -0.6709377765655518, -0.6731659770011902, -0.6736127734184265, -0.6722638010978699,
    -0.6708891987800598, -0.6709162592887878, -0.6727041602134705, -0.6771573424339294, -0.6835319995880127,
    -0.6916314959526062, -0.701880931854248, -0.7132473587989807, -0.7261941432952881, -0.7404559254646301,
    -0.7541279196739197, -0.7673013806343079, -0.779068112373352, -0.7878862023353577, -0.794589638710022,
    -0.7995012402534485, -0.8027971386909485, -0.8053252696990967, -0.8070347309112549, -0.8084712624549866,
    -0.8110464811325073, -0.8154489994049072, -0.8207209706306458, -0.8267256617546082, -0.8355086445808411,
    -0.8457117080688477, -0.8547663688659668, -0.8654868006706238, -0.8783079981803894, -0.8891707062721252,
    -0.8983452916145325, -0.9072567820549011, -0.9139558672904968, -0.9171711206436157, -0.9173070788383484,
    -0.914885401725769, -0.9104771018028259, -0.905013382434845, -0.8987418413162231,
  ],
  [
    0, 55.07501704037932, -100.96532985542939, -33.91986372431215, -21.27381460710989, -9.034851116696384,
    -8.94537129141382, -9.993109454208062, -9.393740846767294, -5.4542647141669285, -9.014989993641871,
    -6.628799607871381, -4.5370522329977545, -2.6862800295106206, 1.4974919073270887, -5.781036511291744,
    -5.630766967887214, -18.825391072916503, -7.287573073902343, -19.652065157014736, -6.055224065187122,
    -12.272608118111137, 3.4022132798102507, -2.016289130188526, 13.753352677819827, 3.1299899704075043,
    7.578770459687739, -1.0207612654577773, -0.7277586872573811, -9.122746461043837, -13.04940304629432,
    -14.054756113398973, -9.367521240205456, 1.563273568745521, 2.9076801244072366, 0.06765100812750116,
    -0.5314704419693408, 6.327149968849184, -2.5073286218666624, -8.982866226004667, -12.062992923122087,
    -3.636855837854922, -2.0280704384393564, -1.5754373669919857, -3.771134777237016, -0.5057330334342327,
    0.669766529317824, 4.549906873648636, 3.0515837610713694, 2.087564178360894, -0.030560774818540415,
    -0.04922470445022703, -2.3474721301489043, -4.4620828132581885, -4.579471874743051, -2.180695403156807,
    -2.2845013425251017, -2.682558327808502, -3.690490664546683, -4.136657269218469, -3.256300474754556,
    -2.732766970495437, -1.2293834973841924, -0.7545498353621263, -0.2317822549713648, 0.3562338714654966,
    1.0730184760585715, 0.6411017809478823, 0.15964048363113276, -0.4866113748236266, -0.40312735633818614,
    -0.7046041400841704, -1.3042785828374768, -1.5690468967548519, -1.0127130845407024, -0.8972232419710323,
    -1.4308151446818678, -1.9005699978587116, -1.950089805836735, -1.784800145345368, -1.9216162832782353,
    -1.7041299936820826, -1.3125792385415096, -0.6651372985120578, -0.1367545539679409, 0.21737035884053307,
    0.008201798216815825, -0.179686717898625, -0.36269316630310344, -0.5194994257925849, -0.9709919034949294,
    -1.3886075174623058, -1.3842600393471316, -1.20762035202001, -1.071688764278086, -0.9618749244702348,
    -0.6941845280905605, -0.4557472458422742, -0.339254918441501, -0.37920842189291104, -0.49901535938813635,
    -0.7292103012468569, -0.8327126524791665, -0.7966748168073051, -0.8042377439408499, -0.9360884233154346,
    -0.8796281539253525, -0.7456763467085881, -0.584621752375299, -0.5667895098968931, -0.5565603984309735,
    -0.49573787356825494, -0.4117634338863021, -0.49725191395242985, -0.6573642389774998, -0.7102591550838558,
    -0.6571970430768206, -0.6088406553755089, -0.6240150094471721, -0.6326787722526495, -0.5963030504256688,
    -0.5026415848005228, -0.42925008641193285, -0.3915299648647683, -0.3783313973510658, -0.3433159866870632,
    -0.3509706724872341, -0.4282039871715355, -0.5863679740577936, -0.6651167342480662, -0.6742575431401558,
    -0.645332369203107, -0.6204281853303566, -0.5533577777259073, -0.5220861954036402, -0.4591276184468822,
    -0.40659159726669003, -0.3620883029300546, -0.37116089615940884, -0.3283554839790931, -0.3245572368936982,
    -0.30035479139600685, -0.34157253617184014, -0.39920448398094144, -0.4000567855439936,
    -0.3925278553614102, -0.3655775330552891, -0.3465532753777336, -0.37228458472063886, -0.42156445805455567,
    -0.4607092930781962, -0.4733683979023441, -0.4450421222773633, -0.46019610571793124, -0.44956552668660865,
    -0.41968367291832287, -0.39491889227005195, -0.37350471713178646, -0.31211719710045305,
    -0.27706376725107607, -0.2449596761193007, -0.19113450338133398, -0.18499274394820087,
    -0.25174889691535196, -0.3273076601664805, -0.3596058349510999, -0.3440888535224492, -0.3521319016072795,
    -0.36142883054362374, -0.34161835391726636, -0.32176390529151083, -0.2780199711411874,
    -0.25798145974917097, -0.27259471958546416, -0.2512470479822141, -0.235683486553931, -0.2136978320065004,
    -0.23732999498263796, -0.2922890077330218, -0.29801755404865427, -0.28832033866210904,
    -0.28973688883144255, -0.289469212990517, -0.2518602736201466, -0.216803044375123, -0.1855887597267355,
    -0.17745779276071, -0.18980768018378613, -0.17302862649836154, -0.16454210618101328, -0.1811765834988603,
    -0.23576813176725825, -0.27084206531176913, -0.2809115919942442, -0.2676059246215924,
    -0.23676806397327033, -0.18626862020396562, -0.1409777722799137, -0.1074489148079012,
    -0.07437591066403426, -0.05638206668607193, -0.08100033026747644, -0.15982021971090532,
    -0.20149010293205016, -0.20574193738958124, -0.2703511566257177, -0.33192970156599017,
    -0.31898467142072595, -0.2550390255820325, -0.16345998764978908, -0.09800081846220776,
    -0.07481306596081183, -0.0616365187044885, -0.04152599336733387, -0.0181253970673394, -0.092817705573218,
    -0.14832137016601799, -0.041924372421790146, -0.019662229869318315, -0.09940406904212651,
    -0.10740959595012639, -0.045295160360381975, -0.048788181952692966, -0.18184209705962517,
    -0.19788100465684977, -0.13511195274718535, -0.18032216663090406, -0.2080126995772904,
    -0.18832217872297113, -0.15506249214584378, -0.09862704475869366, -0.046395860149841095,
    -0.01325288860314533, -0.004607969118707311, -0.009906419469285943, -0.011622856519072577,
    0.003653520275456401, 0.035518439083517706, 0.06841321234987685, 0.08164910373373147, 0.06161864473752221,
    0.011976634629946581, -0.04895716445032372, -0.0979406786916357, -0.11984774858067393,
    -0.11325292488764793, -0.08874364833683934, -0.06053645641640992, -0.03877867641146526,
    -0.026279304926726255, -0.020565427158991234, -0.017669062693733473, -0.014798161336960547,
    -0.011216750337826653, -0.007336639051764848, -0.0035989003391421193, 0, 13.196636183477484,
    -24.697248791422233, -8.836281557543433, -5.44568623562724, -2.423478271953911, -2.015829447358377,
    -2.592263487319561, -2.2611719790865763, -1.4178721167418789, -2.2190377079387815, -1.5289822367538088,
    -1.3724723588191643, -0.5319686636884173, 0.4953556309261191, -0.18724322581208397, -0.7960128006582876,
    -3.4394146097851013, -1.9917303352207092, -4.31530473500424, -2.7849269807066017, -3.540923429737489,
    -1.2553638011442025, -1.3902179418191085, 1.758698667674549, 1.610209232502375, 1.877524802690676,
    1.5169678117992187, 1.0504643905960838, 0.46060935895405786, -1.5231283803326665, -2.585581838842768,
    -3.3161828257143497, -1.2414827376621824, 0.0671754004685372, -0.019858154488149093, -0.6839910829018825,
    1.2721635375862443, 1.3819547700474564, -0.23125178245375622, -2.163976218331795, -1.7945172752988439,
    -0.7726941870365911, -0.3579185352564216, -0.8332351859837972, -0.8383606237821688, -0.7833624949183788,
    -0.05934238996315999, 0.5818029972667076, 0.7404352148468398, 0.6992982176092213, 0.6530186582919968,
    0.7000136327268023, 0.23508060251355078, -0.28080279329283786, -0.3510342287028272, -0.17538601556937672,
    -0.2330547835273884, -0.1431312296491284, -0.5712967740765558, -0.6946237106891902, -0.7476492914895561,
    -0.4953260687748742, -0.1393387170233673, 0, 2.3259598715812517, -5.961788967870776, -2.504009288117836,
    -0.9376218840837072, -0.6201944509907324, -0.15639352276870444, -0.6113524560991884, 0.8440702632069588,
    0.304699088641487, 0.7787493705530361, -0.15423589685067024, 0.06519913669828686, -0.5646845010809876,
    0.2177929313027107, 0.04554613486019399, 0, -0.24044354857539968, -0.9308304823935032,
    -0.6153080076131803, 0, 0, 0, 0, 0, -0.8776373269276516, 0.12985214591026306, -0.6348525287823572, 0, 0,
    0, 0, 0, 3.106771274904294, -4.500080756642596, -1.9216774187609937, -1.209712655377619,
    0.06297954792118632, -0.012903342939311835, -0.49517131275042636, -0.8442570343613625,
    -1.0917119970233937, -0.8200922479353484, -1.078640047027872, -1.103370190692179, -1.4026451796055222,
    -0.8411989500259316, -0.7988992124559158, 0, 0.03816741061800222, -0.389643058180809, -0.2272894446790863,
    0, 0, 0, 0, 0, -0.5770036560111141, 0.14603561162948608, -0.1607030015997979, 0, 0, 0, 0, 0,
    12.833876455792346, -24.519293862525934, -9.123918447972521, -5.612358252644363, -2.5912613510557647,
    -1.9970973793012925, -2.689812612656984, -2.227461294261455, -1.4389029481197328, -2.200225434755501,
    -1.48831670586427, -1.5294341119411394, -0.47939013073629766, 0.5056673044124833, 0.40431711156331795,
    -0.5350947730086348, -2.666830470904407, -2.0109360141226755, -3.7394617316156955, -3.334214829925549,
    -3.611719701740065, -2.3622895419178183, -1.780422056225555, 0.5893724350167203, 1.713526036514869,
    1.4851899475080734, 2.1249338329424323, 1.4047447153753003, 1.6173176608534516, -0.5343932278700145,
    -1.8217289539680577, -3.4010438341647387, -2.174852773957878, -0.5506189768063252, -0.24556632240589793,
    -0.9846512135713131, 0.5575081424765572, 2.056418987528723, 1.0094624199507474, -0.9450972253351276,
    -1.7296623155299709, -0.7126745877002834, -0.36254247722810895, -0.7047421965219229, -1.2917068678308563,
    -1.426894408034205, -1.161236274365464, -0.20061035974245311, 0.1308888389914058, 0.3297983735659583,
    0.31526398390588783, 0.8210685282560084, 0.7499477050347781, 0.16679177524046773, -0.3293182946836517,
    -0.0070112766405094895, 0.16914332756043926, 0.4589950375119971, 0.18803022565339989, 0.08018349903830169,
    0.050777286537593724, 0.05778741754799377, 0.10274596788350188, 0, 2.580244254821649, -5.60613080380068,
    -2.346465416787023, -0.9381606887278827, -0.3657867649728643, -0.2888881256235821, -0.8281493489459201,
    0.2868809327483177, -0.02166700270028865, 0.412531452347047, -0.5937149878786452, -0.5319150547681124,
    -1.0473432354153396, -0.17106387933346845, -0.2138314131199155, 0, -0.21863994250865387,
    -0.9174600914120674, -0.588751229148821, 0, 0, 0, 0, 0, -0.7702620817882068, 0.16656926274299622,
    -0.4897507025462633, 0, 0, 0, 0, 0, 3.1033305986972763, -4.199661613840746, -1.780647536988328,
    -1.2079153060203314, 0.16850785290385867, 0.24124735816662124, -0.1432051245731354, -0.8571190983057022,
    -1.209374006614727, -1.0483664255562264, -0.9776592542573743, -0.9904206692462683, -1.2205993460858762,
    -0.8432029204613136, -0.8433132919441431, 0, 0.08425492601177365, -0.19187305867671967,
    -0.12277042312839337, 0, 0, 0, 0, 0, -0.5820009129903027, 0.1046234667301178, -0.1071409004590218, 0, 0,
    0, 0,
  ],
];

const envelope = (audioCtx: AudioContext, config: AdsrEnvelopeModel['$envelope']['value']) => {
  const gain = audioCtx.createGain();

  const now = audioCtx.currentTime;

  // Attack
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(1, now + config.attack);
  gain.gain.setValueAtTime(1, now + config.attack);
  // Hold
  gain.gain.linearRampToValueAtTime(1, now + config.attack + config.hold);
  // Decay and sustain
  gain.gain.linearRampToValueAtTime(config.sustain, now + config.attack + config.hold + config.decay);

  const stop = () => {
    const now = audioCtx.currentTime;
    gain.gain.cancelScheduledValues(now);
    gain.gain.setValueAtTime(gain.gain.value, now);
    gain.gain.linearRampToValueAtTime(0.001, now + config.release);
  };

  return { stop, envelope: gain };
};

interface OscillatorConfig {
  wave: PeriodicWave;
  frequency: number;
  unison: number;
  detune: number;
  randPhase: number;
}

const unisonOscillator = (audioCtx: AudioContext, config: OscillatorConfig) => {
  const oscillators: OscillatorNode[] = [];
  const from = -config.detune / 2;
  const step = config.detune / (config.unison - 1);

  for (let i = 0; i < config.unison; i++) {
    const oscillator = audioCtx.createOscillator();
    oscillator.setPeriodicWave(config.wave);

    if (config.unison !== 1) oscillator.detune.setValueAtTime(from + step * i, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(config.frequency, audioCtx.currentTime);
    oscillators.push(oscillator);
  }

  const start = (time?: number) =>
    oscillators.forEach(
      (oscillator) => oscillator.start((time ?? audioCtx.currentTime) + Math.random() * config.randPhase) // starts with random phase
    );
  const connect = (node: AudioNode) => oscillators.forEach((oscillator) => oscillator.connect(node));
  const stop = (time?: number) => oscillators.forEach((oscillator) => oscillator.stop(time));

  return { start, connect, stop };
};

const voice = (
  audioCtx: AudioContext,
  outputNode: AudioNode,
  note: Note,
  adsrConfig: AdsrEnvelopeModel['$envelope']['value'],
  oscConfig: Omit<OscillatorConfig, 'frequency'>
) => {
  const uOsc = unisonOscillator(audioCtx, {
    ...oscConfig,
    frequency: getFq(note),
  });
  const adsr = envelope(audioCtx, adsrConfig);
  uOsc.connect(adsr.envelope);
  adsr.envelope.connect(outputNode);

  uOsc.start();
  const stop = () => {
    adsr.stop();
    uOsc.stop(audioCtx.currentTime + adsrConfig.release);
  };
  return { stop };
};

const synth = ({
  inputController: [{ $onPress, $onRelease }],
  adsrEnvelope: [{ $envelope }],
  oscillator: [{ $osc }],
}: Deps) =>
  rxModel(() => {
    const audioCtx = new window.AudioContext();
    const preGain = audioCtx.createGain();
    const masterLimiter = audioCtx.createDynamicsCompressor();
    const masterGain = audioCtx.createGain();
    preGain.gain.setValueAtTime(0.07, audioCtx.currentTime);
    masterGain.gain.setValueAtTime(0.8, audioCtx.currentTime);

    masterLimiter.threshold.setValueAtTime(-12.0, audioCtx.currentTime);
    masterLimiter.ratio.setValueAtTime(1.0, audioCtx.currentTime);
    masterLimiter.attack.setValueAtTime(0.003, audioCtx.currentTime);
    masterLimiter.release.setValueAtTime(0.01, audioCtx.currentTime);

    preGain.connect(masterLimiter);
    masterLimiter.connect(masterGain);
    masterGain.connect(audioCtx.destination);

    return { audioCtx, preGain, masterLimiter, masterGain };
  }).subscriptions(({ audioCtx, preGain }) => {
    const oscillators: Record<string, ReturnType<typeof voice> | null> = {};
    return [
      $onRelease.subscribe((note) => {
        oscillators[noteToString(note)]?.stop();
        oscillators[noteToString(note)] = null;
      }),
      $onPress.subscribe((note) => {
        if (oscillators[noteToString(note)]) return;
        const periodicWave = audioCtx.createPeriodicWave(...wave);

        oscillators[noteToString(note)] = voice(audioCtx, preGain, note, $envelope.value, {
          ...$osc.value,
          wave: periodicWave,
        });
      }),
    ];
  });

export const { ModelProvider: SynthProvider, useModel: useSynth } = rxModelReact('synth', synth);
